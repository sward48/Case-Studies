```{r}
library(janitor)
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(scales)

# for the mixed effects model
library(lme4)
library(arm)

# make select() come from dplyr
select <- dplyr::select

#read in the data
sales_df <- read.csv('data/sales_scraped.csv')
property_df <- readRDS('data/hamden.rds')

sales_df    <- clean_names(sales_df)
property_df <- clean_names(property_df)
```

```{r}
property_keep <- c(
  "pid", "link", 
  "land_acres", "living_area", "effective_area", "total_rooms", "number_of_bedroom",
  "number_of_baths", "number_of_half_baths", "occupancy", "ayb", "eyb",
  "shape_area", "shape_length"
)

property_df <- property_df %>%
    mutate(pid = as.integer(gsub("35650-", "", link))) %>%
    filter(!is.na(pid)) %>%
    select(all_of(property_keep))

# merge on pid (keep all properties; bring in sales/appraisal cols)
merged_df <- property_df %>% left_join(sales_df, by = "pid")
str(merged_df)
```

```{r}
df <- merged_df %>%
  mutate(
    sale_date = ymd(sale_date),
    sale_year = year(sale_date),

    # choose the assessment snapshot closest to the sale date
    assessed_total = case_when(
      !is.na(total_2024) & sale_year >= 2024 ~ total_2024,
      !is.na(total_2023) & sale_year <= 2023 ~ total_2023,
      TRUE ~ coalesce(total_2024, total_2023)
    ),

    # core ratios
    ratio_assess = assessed_total / sale_price,    # target ~0.70 in CT
    ratio_equal  = (assessed_total / 0.70) / sale_price  # target ~1.00
  )

# keep plausible, recent sales
recent <- df %>%
  filter(
    !is.na(sale_price), sale_price > 10000, sale_price < 10000000, 
    occupancy == 1,
    sale_date >= as.Date("2023-01-01"), 
    !is.na(assessed_total)
  ) %>%
  # trim extreme outliers in ratio to stabilize metrics
  filter(between(ratio_assess, 0.2, 2))

nrow(recent)
summary(select(recent, sale_price, assessed_total, ratio_assess, ratio_equal))
```

```{r}
#filter the data set to get rid of low sales prices
df <- df %>%
    filter(sale_price > 100000)

#make the years into factors
df <- df %>%
    mutate(year_factor = as.factor(sale_year)) %>%
    filter(year_factor == c('2023', '2024')) %>%
    mutate(bath_factor = as.factor(number_of_baths)) %>%
    mutate(bed_factor = as.factor(number_of_bedroom))

#maybe make the bed/bath into a factor

```

```{r}
#make a model
#switch assesed to log
model <- lm(log(assessed_total) ~ year_factor*bath_factor + 
    year_factor*bed_factor + living_area + land_acres, data = df)
summary(model)
```

```{r}
#make a mixed effects model using the factor variables

model <- lmer(log(assessed_total) ~ (year_factor | bath_factor) + 
    (year_factor | bed_factor) + living_area + land_acres, data = df)
summary(model)

re <- ranef(model, condVar = TRUE)
slope_bath <- re$bath_factor
slope_bath$bath_factor <- rownames(slope_bath)
slope_bath <- slope_bath %>%
    clean_names() %>%
    rename(slope = year_factor2024)
se <- se.ranef(model)
se_bath <- se$bath_factor
#se_bath$bath_factor <- rownames(se_bath)
toplot <- cbind(slope_bath, se_bath)


ggplot(toplot, aes(x = bath_factor, y = slope)) +
  geom_point() +
  geom_errorbar(aes(ymin=slope - year_factor2024, ymax=slope + year_factor2024)) +
  labs(x = "# of Baths",
       y = "Slope",
       title = "Slope of Baths for Mixed Effects Model")

dev.copy2pdf(file = "figures/Bathroom_Slopes.pdf", width = 7, height = 5)


re <- ranef(model, condVar = TRUE)
slope_bed <- re$bed_factor
slope_bed$bed_factor <- rownames(slope_bed)
slope_bed <- slope_bed %>%
    clean_names() %>%
    rename(slope = year_factor2024)
se <- se.ranef(model)
se_bed <- se$bed_factor
#se_bath$bath_factor <- rownames(se_bath)
toplot <- cbind(slope_bed, se_bed)


ggplot(toplot, aes(x = bed_factor, y = slope)) +
  geom_point() +
  geom_errorbar(aes(ymin=slope - year_factor2024, ymax=slope + year_factor2024)) +
  labs(x = "# of Bedrooms",
       y = "Slope",
       title = "Slope of Bedrooms for Mixed Effects Model")

dev.copy2pdf(file = "figures/Bedroom_Slopes.pdf", width = 7, height = 5)
```